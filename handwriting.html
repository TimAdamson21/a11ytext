<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>Handwriting</title>
    <link rel="icon">
    <meta charset="UTF-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.5.2/superagent.min.js"></script>
    <link rel="stylesheet" type="text/css" href="a11ytext.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<style>body {font-size:12pt}</style>
</head>
<body>

    <div class="container-fluid text-center">
  <div class="row content">
    <div class="col-sm-2 sidenav">

		Contrast<br>
        <label class="switch">

            <input id ="myCheck" type="checkbox" onclick="changeContrast()">
            <span class="slider round"></span>
        </label><br>

		Font Size<br>
        <div>
            <button class="btn btn-primary" id ="increaseFont" onclick="changeFontSize(3)">+</button>
            <button class="btn btn-primary" id ="decreaseFont" onclick="changeFontSize(-3)">-</button>
        </div><br>

        <div id ="fontChange">
        <button type="button" onclick="changeFont()">Font Type</button>
        </div>
        <br>
        <textarea readonly id="conversionStatus" style="width:100%; height:100px;"></textarea>
    </div>
    
    <div class="col-sm-8 text-left" style="height: 650px">
      <textarea readonly id="displayText" style="width:100%; height:100%;"></textarea>
  </div>
  <div class="col-sm-2 sidenav">
  
Print
<label class="switch" name="choose handwriting or printed text">

    <input id ="handwritingCheck" type="checkbox">
    <span class="slider round"></span>
</label>
By Hand<br><br>

Accepts PDFs and images (JPG and PNG).
<br><br>
<input type="text" name="inputImage" id="inputImage" value="https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/Atomist_quote_from_Democritus.png/338px-Atomist_quote_from_Democritus.png" />
<button onclick="handleFile(null)">Read image</button>
<br><br>
<input type="file" id="input" onchange="handleFile(this.files[0])">
<br><br>
<button id="create" onclick="download()">Create file</button> <a download="A11yText.txt" id="downloadLink" style="display: none">Download</a>



<div id="imageDiv" style="width:150%; display:table-cell;">
    
    <br><br>
    <img id="sourceImage" width="400" />
</div>
  </div>

</div>
</div>

<script type="text/javascript">

    // Replace or verify the region.
    //
    // You must use the same region in your REST API call as you used to obtain your subscription keys.
    // For example, if you obtained your subscription keys from the westus region, replace
    // "westcentralus" in the URI below with "westus".
    //
    // NOTE: Free trial subscription keys are generated in the westcentralus region, so if you are using
    // a free trial subscription key, you should not need to change this region.
    var uriBase = "https://westcentralus.api.cognitive.microsoft.com/vision/v1.0/";

	/*
	 * changes the contrast back and forth between the text/background being
	 * black/white respectively
	 */
    function changeContrast() {
        var checkBox = document.getElementById("myCheck");
        var textArea = document.getElementById("displayText");
        if(checkBox.checked) {
            //alert("checked");
            textArea.style.backgroundColor = "black";
            textArea.style.color = "white";
        } else {
            textArea.style.backgroundColor = "white";
            textArea.style.color = "black";
        }
    }

    /*
     *  changes the text-box font size by "delta" points
     */
    function changeFontSize(delta) {
        var textArea = document.getElementById("displayText");
        style = window.getComputedStyle(textArea, null).getPropertyValue('font-size');
        currentSize = parseFloat(style);
        textArea.style.fontSize = (currentSize + delta) + 'px';
    }

    /**
     *  toggles through four popular fonts
     *  TODO: allow for any standard font
     *  TODO: get rid of duplicated code
     */
    function changeFont() {
        var fon = document.getElementById("displayText");
        if (fon.className == "arial") {
          fon.className = 'roman';
        } else if (fon.className == "roman"){
          fon.className = 'helvetica';
        } else if (fon.className == "helvetica") {
          fon.className = 'calibri';
        } else {
          fon.className = 'arial';
        }
    }

    var textFile = null,
    makeTextFile = function (text) {
        var data = new Blob([text], {type: 'text/plain'});
	    if (textFile !== null) {
	    	// revoke previous file's object URL to avoid memory leaks
	    	window.URL.revokeObjectURL(textFile);
	    }
        textFile = window.URL.createObjectURL(data);
        return textFile;
    };

    function download() {
        var create = document.getElementById('create'),
        textbox = document.getElementById('displayText');
        var link = document.getElementById('downloadLink');
        link.href = makeTextFile(textbox.value);
        link.style.display = 'block';
    }

    function dataURLtoFile(dataurl, filename) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
    }

   	function handleFile(file) {
   		$("#conversionStatus").val("Converting to text. Please wait 10 seconds.");
        if (file.type === "image/jpeg" || file.type === "image/png") {
            // user uploaded an image
            var newText = processImage(file, true, true);
        } else if (file.type === "application/pdf") {
            // user uploaded a pdf
            processPDF(file);
        } else {
            alert("Illegal file type.");
        }
    }
   	
   	function urlToDownloadName(url) {
	  	return url.substring(url.lastIndexOf("/") + 1, url.lastIndexOf(".")) + ".txt";
   	}

   	function fileToDownloadName(fileName) {
	  	return fileName.substring(0, fileName.lastIndexOf(".")) + ".txt";
   	}
    
   	function processPDF(pdfFile) {
        var formData = new FormData();
        formData.append('File', pdfFile, pdfFile.name);
        formData.append('JpgQuality', '50');
        formData.append('ImageResolutionH', '200');
        formData.append('ImageResolutionV', '200');
        $.ajax({
            url: 'https://v2.convertapi.com/pdf/to/jpg?Secret=cNcz3EUfhq9dTdZc',
            data: formData,
            processData: false,
            contentType: false,
            method: 'POST',
            success: function(data) {
            	// pdf conversion successful
            	// process the first page
            	var urlString = "data:text/plain;base64," + data.Files[0].FileData;
                var file = dataURLtoFile(urlString, pdfFile.name);
                processImage(file);
            }
        })
        .fail(function() {
        	// give error alert, since PDF conversion failed
        	document.getElementById('displayText').value = "";
        	alert("Error converting PDF.");
        })
    }

    function processImage(image) {
    	var downloadName;
    	if (image == null) {
    		var sourceImageUrl = document.getElementById("inputImage").value;
    		document.querySelector("#sourceImage").src = sourceImageUrl;
    		downloadName = urlToDownloadName(sourceImageUrl);
    		image = '{"url": "' + sourceImageUrl + '"}';
    	} else {
    		displaySourceImage(image);
        	downloadName = fileToDownloadName(image.name);
    	}
    	// set the download attribute to be used when "download" is clicked
    	document.getElementById("downloadLink").download = downloadName;
    	// **********************************************
        // *** Update or verify the subscriptionKey string value with your valid subscription key. ***
        // **********************************************
        var subscriptionKey = "77a01c5eff1f47c4812a001a082c7728";

        // Request parameters.
        var params = {
            "handwriting": "true",
        };

        // This operation requrires two REST API calls. One to submit the image for processing,

        // the other to retrieve the text found in the image.
        //
        // Perform the first REST API call to submit the image for processing.


        superagent
            .post(uriBase + "RecognizeText?" + $.param(params))

            .set("Content-Type", "application/octet-stream")

            .set("x-ms-version", "2017-04-17")

            .set("x-ms-blob-type", "BlockBlob")
            
            .set("x-ms-blob-content-type", image.type)

            .set("Ocp-Apim-Subscription-Key", subscriptionKey)

            .send(image)

            .end(function(err, res) {

                if (err) {
                	
                	alert("Conversion failed.")

                    console.log(err);

                } else {
                    // Note: The response may not be immediately available. Handwriting recognition is an
                    // async operation that can take a variable amount of time depending on the length
                    // of the text you want to recognize. You may need to wait or retry this GET operation.
                    //
                    // Wait ten seconds before making the second REST API call.

                    setTimeout(function () {

                        // The "Operation-Location" in the response contains the URI to retrieve the recognized text.
                        var operationLocation = res.xhr.getResponseHeader("Operation-Location");

                        // Perform the second REST API call and get the response.
                        $.ajax({
                            url: operationLocation,

                            // Request headers.
                            beforeSend: function(jqXHR){
                                jqXHR.setRequestHeader("Content-Type","application/json");
                                jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
                            },

                            type: "GET",
                        })

                            .done(function(data) {
                               var obj = JSON.parse(JSON.stringify(data, null, 2));

                                // var lines = obj.recognitionResult.lines.sort((a, b) => a.boundingBox[1] - b.boundingBox[1]);
                                var lines = obj.recognitionResult.lines;
                                
                                var result = '';

                                for(var i = 0; i < lines.length; i+=1) {
                                    var line = lines[i];
                                    result += line.text + '\n';
                                }
                               	$("#displayText").val(result);
                             	$("#conversionStatus").val("Conversion complete.");
                            })

                            .fail(function(jqXHR, textStatus, errorThrown) {
                                // Display error message.
                                var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                                errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                                    jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
                                alert(errorString);
                            });
                    }, 10000);


                }

            });
    };

    function displaySourceImage(file) {
        var reader = new FileReader();
        reader.onload = function (e) {
            $('#sourceImage')
                .attr('src', e.target.result);
        };
        reader.readAsDataURL(file);
    }
    
    function processOnlineImage(){
        var sourceImageUrl = document.getElementById("displayText").value;
        console.log(sourceImageUrl);
        var imageData = '{"url": ' + '"' + sourceImageUrl + '"}'
        processImage(imageData);
    }
</script>
<h2>Convert PDFs and Images to Text</h2>
</body>
</html>
