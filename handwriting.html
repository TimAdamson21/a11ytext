<!DOCTYPE html>
<html>
<head>
    <title>Handwriting Sample</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.5.2/superagent.min.js"></script>
</head>
<body>

<script type="text/javascript">
   

    function dataURLtoFile(dataurl, filename) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
    }

    function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {type: contentType});
        return blob;
    }

   function handleFiles(files){
        var file = files[0];
        var type = file.type;
        console.log(type);

        if(type === "image/jpeg" || type === "image/png"){
            console.log("You uploaded an image");
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#sourceImage')
                    .attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
            processImage(file);
        }

        else if(type === "application/pdf"){
            console.log("You uploaded a pdf");
            processPDF(file);
        }
        else{
            console.error("Illegal file type");
        }

    }

    
    function processPDF(pdfFile){
        var formData = new FormData();
        formData.append('File', pdfFile, pdfFile.name);
        formData.append('JpgQuality', '50');
        formData.append('ImageResolutionH', '200');
        formData.append('ImageResolutionV', '200');

        $.ajax({
            url: 'https://v2.convertapi.com/pdf/to/jpg?Secret=DrS0i33shLt0ZnHj',
            data: formData,
            processData: false,
            contentType: false,
            method: 'POST',
            success: function(data) {
                console.log("We had success!");
                console.log(data);
                var urlString = "data:text/plain;base64," + data.Files[0].FileData;

                /*
                var blob = b64toBlob(data.Files[0].FileData, "image/jpeg")
                console.log(blob);
                var file = new File(blob, "image111.jpg");
                */

                var file = dataURLtoFile(urlString, "hello.txt");

                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#sourceImage')
                        .attr('src', e.target.result);
                };
                reader.readAsDataURL(file);

                console.log(file);
                processImage(file);
            }
        })


    }
    
    function processOnlineImage(){
        var sourceImageUrl = document.getElementById("inputImage").value;
        var imageData = '{"url": ' + '"' + sourceImageUrl + '"}'
        processImage(imageData);
    }

    function processImage(imageFile) {
        // **********************************************
        // *** Update or verify the following values. ***
        // **********************************************

        // Replace the subscriptionKey string value with your valid subscription key.
        var subscriptionKey = "8103c099c1d44c708b14fe6ca902fcc5";

        // Replace or verify the region.
        //
        // You must use the same region in your REST API call as you used to obtain your subscription keys.
        // For example, if you obtained your subscription keys from the westus region, replace
        // "westcentralus" in the URI below with "westus".
        //
        // NOTE: Free trial subscription keys are generated in the westcentralus region, so if you are using
        // a free trial subscription key, you should not need to change this region.
        var uriBase = "https://westcentralus.api.cognitive.microsoft.com/vision/v1.0/RecognizeText";

        // Request parameters.
        var params = {
            "handwriting": "true",
        };

        // Display the image.


        // This operation requrires two REST API calls. One to submit the image for processing,

        // the other to retrieve the text found in the image.
        //
        // Perform the first REST API call to submit the image for processing.


        superagent
            .post(uriBase + "?" + $.param(params))

            .set("Content-Type", "application/octet-stream")

            .set("x-ms-version", "2017-04-17")

            .set("x-ms-blob-type", "BlockBlob")

            .set("x-ms-blob-content-type", imageFile.type)

            .set("Ocp-Apim-Subscription-Key", subscriptionKey)

            .send(imageFile)

            .end(function(err, res) {

                if (err) {

                    console.log(err);

                    console.dir(res);

                } else {
                    console.log(err);
                    console.log(res);
                    $("#responseTextArea").val("Handwritten text submitted. Waiting 10 seconds to retrieve the recognized text.");

                    // Note: The response may not be immediately available. Handwriting recognition is an
                    // async operation that can take a variable amount of time depending on the length
                    // of the text you want to recognize. You may need to wait or retry this GET operation.
                    //
                    // Wait ten seconds before making the second REST API call.

                    setTimeout(function () {

                        // The "Operation-Location" in the response contains the URI to retrieve the recognized text.
                        var operationLocation = res.xhr.getResponseHeader("Operation-Location");

                        // Perform the second REST API call and get the response.
                        $.ajax({
                            url: operationLocation,

                            // Request headers.
                            beforeSend: function(jqXHR){
                                jqXHR.setRequestHeader("Content-Type","application/json");
                                jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
                            },

                            type: "GET",
                        })

                            .done(function(data) {
                                // Show formatted JSON on webpage.
                                // $("#responseTextArea").val(JSON.stringify(data, null, 2));

                               var obj = JSON.parse(JSON.stringify(data, null, 2));

                                // var lines = obj.recognitionResult.lines.sort((a, b) => a.boundingBox[1] - b.boundingBox[1]);
                                var lines = obj.recognitionResult.lines;

                               var s = '';

                                for(var i = 0; i < lines.length; i+=1) {
                                    var line = lines[i];
                                    s += line.text + '\n';
                                    // console.log(line.text);
                                }
                                $("#responseTextArea").val(s);
                            })

                            .fail(function(jqXHR, textStatus, errorThrown) {
                                // Display error message.
                                var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                                errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                                    jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
                                alert(errorString);
                            });
                    }, 10000);


                }

            });


/*

        $.ajax({
            url: uriBase + "?" + $.param(params),

            // Request headers.
            beforeSend: function(jqXHR){
                jqXHR.setRequestHeader("Content-Type","application/json");
                jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
            },

            type: "POST",
            contentType: 'application/octet-stream',
            // Request body.
            processData: false,
            data: imageFile

        })

        .done(function(data, textStatus, jqXHR) {
            // Show progress.
            $("#responseTextArea").val("Handwritten text submitted. Waiting 10 seconds to retrieve the recognized text.");

            // Note: The response may not be immediately available. Handwriting recognition is an
            // async operation that can take a variable amount of time depending on the length
            // of the text you want to recognize. You may need to wait or retry this GET operation.
            //
            // Wait ten seconds before making the second REST API call.

            setTimeout(function () {

                // The "Operation-Location" in the response contains the URI to retrieve the recognized text.
                var operationLocation = jqXHR.getResponseHeader("Operation-Location");

                // Perform the second REST API call and get the response.
                $.ajax({
                    url: operationLocation,

                    // Request headers.
                    beforeSend: function(jqXHR){
                        jqXHR.setRequestHeader("Content-Type","application/json");
                        jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
                    },

                    type: "GET",
                })

                .done(function(data) {
                    // Show formatted JSON on webpage.
                    // $("#responseTextArea").val(JSON.stringify(data, null, 2));

                    obj = JSON.parse(JSON.stringify(data, null, 2));

                    var lines = obj.recognitionResult.lines.sort((a, b) => a.boundingBox[1] - b.boundingBox[1]);

                    s = '';

                    for(i = 0; i < lines.length; i+=1) {
                      var line = lines[i];
                      s += line.text + '\n';
                    }
                    $("#responseTextArea").val(s);
                })

                .fail(function(jqXHR, textStatus, errorThrown) {
                    // Display error message.
                    var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                    errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                        jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
                    alert(errorString);
                });
            }, 10000);



        })

        .fail(function(jqXHR, textStatus, errorThrown) {
            // Put the JSON description into the text area.
            $("#responseTextArea").val(JSON.stringify(jqXHR, null, 2));

            // Display error message.
            var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
            errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
            alert(errorString);
        });
        */


    };

    // function readURL(input) {
    //     if (input.files && input.files[0]) {
    //         var reader = new FileReader();
    //
    //         reader.onload = function (e) {
    //             $('#sourceImage')
    //                 .attr('src', e.target.result);
    //         };
    //
    //         reader.readAsDataURL(input.files[0]);
    //     }
    // }
</script>
<h1>Read handwritten image</h1>
<!-- Enter the URL to an image of handwritten text, then click the <strong>Read image</strong> button. -->
<!-- <br><br> -->
<!-- Image to read: <input type="text" name="inputImage" id="inputImage" value="https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Cursive_Writing_on_Notebook_paper.jpg/800px-Cursive_Writing_on_Notebook_paper.jpg" /> -->
<!-- <button onclick="processOnlineImage()">Read image</button> -->
<!-- <br><br> -->
<input type="file" id="input" multiple onchange="handleFiles(this.files)">
<br><br>
<div id="wrapper" style="width:1020px; display:table;">
    <div id="jsonOutput" style="width:600px; display:table-cell;">
        Response:
        <br><br>
        <textarea id="responseTextArea" class="UIInput" style="width:580px; height:400px;"></textarea>
    </div>
    <div id="imageDiv" style="width:420px; display:table-cell;">
        Source image:
        <br><br>
          <img id="sourceImage" width="400" />
    </div>
</div>
</body>
</html>
