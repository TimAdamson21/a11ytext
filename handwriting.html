<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>Handwriting</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/3.5.2/superagent.min.js"></script>
    <link rel="stylesheet" type="text/css" href="a11ytext.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>

    <div class="container-fluid text-center">
  <div class="row content">
    <div class="col-sm-2 sidenav">

        <label class="switch">

            <input id ="myCheck" type="checkbox" onclick="changeContrast()">
            <span class="slider round"></span>
        </label>


        <div>
            <button class="btn btn-primary" id ="increaseFont" onclick="increaseFont()">+</button>
            <button class="btn btn-primary" id ="decreaseFont" onclick="decreaseFont()">-</button>
        </div>

        <div id ="fontChange">
        <button type="button" onclick="changeFont()">Change the font</button>
        </div>
        

    </div>
    
    <div class="col-sm-8 text-left" style="height: 650px">
      <textarea id="displayText" style="width:100%; height:100%;"></textarea>
  </div>
  <div class="col-sm-2 sidenav">
    
<input type="text" name="inputImage" id="inputImage" value="https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Cursive_Writing_on_Notebook_paper.jpg/800px-Cursive_Writing_on_Notebook_paper.jpg" />
<button onclick="handleFiles([document.getElementById('inputImage').value])">Read image</button>
<br><br>
<input type="file" id="input" multiple onchange="handleFiles(this.files)">
If multiple, first file used.<br>
<br><br>
<button id="create" onclick="download()">Create file</button> <a id="downloadlink" style="display: none">Download</a>
<br><br>
Accepts PDFs and images.

<div id="imageDiv" style="width:150%; display:table-cell;">
    
    <br><br>
    <img id="sourceImage" width="400" />
</div>
  </div>

</div>
</div>

<script type="text/javascript">

	/*
	 * changes the contrast back and forth between the text/background being
	 * black/white respectively
	 */
    function changeContrast() {

        var checkBox = document.getElementById("myCheck");
        var textArea = document.getElementById("displayText");


        if(checkBox.checked) {
            //alert("checked");
            textArea.style.backgroundColor = "black";
            textArea.style.color = "white";
        } else {
            textArea.style.backgroundColor = "white";
            textArea.style.color = "black";
        }


    }

    /*
     *  increases the text-box font by two points
     */
    function increaseFont() {

        var textArea = document.getElementById("displayText");

        style = window.getComputedStyle(textArea, null).getPropertyValue('font-size');
        currentSize = parseFloat(style);
        textArea.style.fontSize = (currentSize + 5) + 'px';

    }

    /*
     *  decreases the text-box font by two points
     */
    function decreaseFont() {

        var textArea = document.getElementById("displayText");

        style = window.getComputedStyle(textArea, null).getPropertyValue('font-size');
        currentSize = parseFloat(style);
        textArea.style.fontSize = (currentSize - 2) + 'px';

    }

    /**
     *  toggles through four popular fonts
     *  TODO: allow for any standard font
     *  TODO: get rid of duplicated code
     */
    function changeFont() {
        var fon = document.getElementById("displayText");
        if (fon.className == "arial") {
          fon.className = 'roman';
        } else if (fon.className == "roman"){
          fon.className = 'helvetica';
        } else if (fon.className == "helvetica") {
          fon.className = 'calibri';
        } else {
          fon.className = 'arial';
        }
    }

    var textFile = null,
    makeTextFile = function (text) {
        var data = new Blob([text], {type: 'text/plain'});

	    // If we are replacing a previously generated file we need to
	    // manually revoke the object URL to avoid memory leaks.
	    if (textFile !== null) {
	    	window.URL.revokeObjectURL(textFile);
	    }

        textFile = window.URL.createObjectURL(data);

        return textFile;
    };

    function download() {
        var create = document.getElementById('create'),
        textbox = document.getElementById('displayText');
        var link = document.getElementById('downloadlink');
        link.href = makeTextFile(textbox.value);
        link.style.display = 'block';
        link.download = "yes";
    }

    function dataURLtoFile(dataurl, filename) {
        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
    }

    function b64toBlob(b64Data, contentType, sliceSize) {
        contentType = contentType || '';
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {type: contentType});
        return blob;
    }

   function handleFiles(files) {
        var file = files[0];
        var type = file.type;
        console.log(type);
        
        var link = document.getElementById("downloadLink");
        link.download = file;

        if (type === "image/jpeg" || type === "image/png") {
            console.log("You uploaded an image");
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#sourceImage')
                    .attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
            processImage(file);
        }

        else if (type === "application/pdf"){
            console.log("You uploaded a pdf");
            processPDF(file);
        }
        else {
            console.error("Illegal file type");
        }
    }

    
    function processPDF(pdfFile){
        var formData = new FormData();
        formData.append('File', pdfFile, pdfFile.name);
        formData.append('JpgQuality', '50');
        formData.append('ImageResolutionH', '200');
        formData.append('ImageResolutionV', '200');

        $.ajax({
            url: 'https://v2.convertapi.com/pdf/to/jpg?Secret=DrS0i33shLt0ZnHj',
            data: formData,
            processData: false,
            contentType: false,
            method: 'POST',
            success: function(data) {
                console.log("We had success!");
                console.log(data);
                var urlString = "data:text/plain;base64," + data.Files[0].FileData;

                
                var blob = b64toBlob(data.Files[0].FileData, "image/jpeg")
                console.log(blob);
                //var file = new File(blob, "image111.jpg");
                

                var file = dataURLtoFile(urlString, "hello.txt");

                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#sourceImage')
                        .attr('src', e.target.result);
                };
                reader.readAsDataURL(file);

                console.log(file);
                processImage(file);
            }
        })


    }
    
    function processOnlineImage(){
        var sourceImageUrl = document.getElementById("displayText").value;
        console.log(sourceImageUrl);
        var imageData = '{"url": ' + '"' + sourceImageUrl + '"}'
        processImage(imageData);
    }

    function processImage(imageFile) {
        // **********************************************
        // *** Update or verify the following values. ***
        // **********************************************

        // Replace the subscriptionKey string value with your valid subscription key.
        var subscriptionKey = "77a01c5eff1f47c4812a001a082c7728";

        // Replace or verify the region.
        //
        // You must use the same region in your REST API call as you used to obtain your subscription keys.
        // For example, if you obtained your subscription keys from the westus region, replace
        // "westcentralus" in the URI below with "westus".
        //
        // NOTE: Free trial subscription keys are generated in the westcentralus region, so if you are using
        // a free trial subscription key, you should not need to change this region.
        var uriBase = "https://westcentralus.api.cognitive.microsoft.com/vision/v1.0/RecognizeText?";

        // Request parameters.
        var params = {
            "handwriting": "true",
        };

        // Display the image.


        // This operation requrires two REST API calls. One to submit the image for processing,

        // the other to retrieve the text found in the image.
        //
        // Perform the first REST API call to submit the image for processing.


        superagent
            .post(uriBase + $.param(params))

            .set("Content-Type", "application/octet-stream")

            .set("x-ms-version", "2017-04-17")

            .set("x-ms-blob-type", "BlockBlob")

            .set("x-ms-blob-content-type", imageFile.type)

            .set("Ocp-Apim-Subscription-Key", subscriptionKey)

            .send(imageFile)

            .end(function(err, res) {

                if (err) {

                    console.log(err);

                    console.dir(res);

                } else {
                    console.log(err);
                    console.log(res);
                    $("#displayText").val("Handwritten text submitted. Please wait 10 seconds.");

                    // Note: The response may not be immediately available. Handwriting recognition is an
                    // async operation that can take a variable amount of time depending on the length
                    // of the text you want to recognize. You may need to wait or retry this GET operation.
                    //
                    // Wait ten seconds before making the second REST API call.

                    setTimeout(function () {

                        // The "Operation-Location" in the response contains the URI to retrieve the recognized text.
                        var operationLocation = res.xhr.getResponseHeader("Operation-Location");

                        // Perform the second REST API call and get the response.
                        $.ajax({
                            url: operationLocation,

                            // Request headers.
                            beforeSend: function(jqXHR){
                                jqXHR.setRequestHeader("Content-Type","application/json");
                                jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
                            },

                            type: "GET",
                        })

                            .done(function(data) {
                                // Show formatted JSON on webpage.
                               //$("#responseTextArea").val(JSON.stringify(data, null, 2));

                               var obj = JSON.parse(JSON.stringify(data, null, 2));

                                // var lines = obj.recognitionResult.lines.sort((a, b) => a.boundingBox[1] - b.boundingBox[1]);
                                var lines = obj.recognitionResult.lines;

                               var s = '';

                                for(var i = 0; i < lines.length; i+=1) {
                                    var line = lines[i];
                                    s += line.text + '\n';
                                    // console.log(line.text);
                                }
                                $("#displayText").val(s);
                            })

                            .fail(function(jqXHR, textStatus, errorThrown) {
                                // Display error message.
                                var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                                errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                                    jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
                                alert(errorString);
                            });
                    }, 10000);


                }

            });




        $.ajax({
            url: uriBase + $.param(params),

            // Request headers.
            beforeSend: function(jqXHR){
                jqXHR.setRequestHeader("Content-Type","application/json");
                jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
            },

            type: "POST",
            //contentType: 'application/octet-stream',
            // Request body.
            //processData: false,
            data: imageFile

        })

        .done(function(data, textStatus, jqXHR) {
            // Show progress.
            $("#displayText").val("Handwritten text submitted. Waiting 10 seconds to retrieve the recognized text.");

            // Note: The response may not be immediately available. Handwriting recognition is an
            // async operation that can take a variable amount of time depending on the length
            // of the text you want to recognize. You may need to wait or retry this GET operation.
            //
            // Wait ten seconds before making the second REST API call.

            setTimeout(function () {

                // The "Operation-Location" in the response contains the URI to retrieve the recognized text.
                var operationLocation = jqXHR.getResponseHeader("Operation-Location");

                // Perform the second REST API call and get the response.
                $.ajax({
                    url: operationLocation,

                    // Request headers.
                    beforeSend: function(jqXHR){
                        jqXHR.setRequestHeader("Content-Type","application/json");
                        jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
                    },

                    type: "GET",
                })

                .done(function(data) {
                    // Show formatted JSON on webpage.
                    /*$("#responseTextArea").val(JSON.stringify(data, null, 2));

                    obj = JSON.parse(JSON.stringify(data, null, 2));

                    var lines = obj.recognitionResult.lines.sort((a, b) => a.boundingBox[1] - b.boundingBox[1]);

                    s = '';

                    for(i = 0; i < lines.length; i+=1) {
                      var line = lines[i];
                      s += line.text + '\n';
                    }
                    $("#responseTextArea").val(s);*/
                })

                .fail(function(jqXHR, textStatus, errorThrown) {
                    // Display error message.
                    var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
                    errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                        jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
                    alert(errorString);
                });
            }, 10000);



        })

        .fail(function(jqXHR, textStatus, errorThrown) {
            // Put the JSON description into the text area.
            //$("#responseTextArea").val(JSON.stringify(jqXHR, null, 2));

            // Display error message.
            var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
            errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
            alert(errorString);
        });
        


    };

     function readURL(input) {
         if (input.files && input.files[0]) {
             var reader = new FileReader();
    
             reader.onload = function (e) {
                 $('#sourceImage')
                     .attr('src', e.target.result);
             };
    
             reader.readAsDataURL(input.files[0]);
         }
     }
</script>
<h2>Convert Handwriting Images to Text</h2>
<!-- Enter the URL to an image of handwritten text, then click the <strong>Read image</strong> button. -->
<!-- <br><br> -->

<!-- <br><br> -->

<!-- <br><br>
  <div id="wrapper" style="width:1020px; display:table;">
    <div id="jsonOutput" style="width:600px; display:table-cell;">
        Response:
        <br><br>
        <textarea id="responseTextArea" class="UIInput" style="width:580px; height:400px;"></textarea>
    </div>
    <div id="imageDiv" style="width:420px; display:table-cell;">
        Source image:
        <br><br>
          <img id="sourceImage" width="400" />
    </div> -->
</div>
</body>
</html>
